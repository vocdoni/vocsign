name: CI and Release

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install Linux GUI build dependencies
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            pkg-config \
            libx11-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libx11-xcb-dev \
            libxcursor-dev \
            libxfixes-dev \
            libwayland-dev \
            libegl1-mesa-dev \
            libgles2-mesa-dev \
            libvulkan-dev

      - name: Run tests
        run: make test

  build_core:
    name: Build Linux and Windows
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Linux and Windows binaries (Docker cross toolchain)
        run: make release-docker-core

      - name: Package core artifacts
        run: |
          mkdir -p release-pack
          tar -C build -czf release-pack/vocsign-linux-amd64.tar.gz vocsign-linux-amd64
          zip -j -9 release-pack/vocsign-windows-amd64.zip build/vocsign-windows-amd64.exe

      - name: Upload core artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-core
          path: |
            release-pack/vocsign-linux-amd64.tar.gz
            release-pack/vocsign-windows-amd64.zip
          if-no-files-found: error

  build_macos:
    name: Build macOS
    runs-on: ${{ matrix.runner }}
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: amd64
          - runner: macos-latest
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build host macOS binary
        run: make build-host

      - name: Package macOS artifact
        run: |
          mkdir -p release-pack
          tar -C build -czf release-pack/vocsign-darwin-${{ matrix.arch }}.tar.gz vocsign-darwin-${{ matrix.arch }}

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos-${{ matrix.arch }}
          path: release-pack/vocsign-darwin-${{ matrix.arch }}.tar.gz
          if-no-files-found: error

  release:
    name: Publish release assets
    runs-on: ubuntu-latest
    needs:
      - build_core
      - build_macos
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download core binaries
        uses: actions/download-artifact@v4
        with:
          name: release-core
          path: release-assets

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          pattern: release-macos-*
          merge-multiple: true
          path: release-assets

      - name: Generate checksums
        run: |
          cd release-assets
          for f in vocsign-*.tar.gz vocsign-*.zip; do
            if [ -f "$f" ]; then
              shasum -a 256 "$f" > "$f.sha256"
            fi
          done

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/vocsign-linux-amd64.tar.gz
            release-assets/vocsign-windows-amd64.zip
            release-assets/vocsign-darwin-*.tar.gz
            release-assets/vocsign-linux-amd64.tar.gz.sha256
            release-assets/vocsign-windows-amd64.zip.sha256
            release-assets/vocsign-darwin-*.tar.gz.sha256
          generate_release_notes: true
